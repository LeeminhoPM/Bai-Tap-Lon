@model ProductVM

@{
    ViewBag.Title = "Sản phẩm";
}

@section naviheader {
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="~/adminPageAssets/index3.html" class="nav-link">Trang chủ</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link">@ViewBag.Title</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link">@(Model.Product.ProductId == 0 ? "Thêm mới" : "Cập nhật")</a>
        </li>
    </ul>
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Quản lý @ViewBag.Title</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">@ViewBag.Title</a></li>
                    <li class="breadcrumb-item active">@((Model.Product.ProductId == 0 ? "Thêm mới" : "Cập nhật") + " " + ViewBag.Title)</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Thông tin @ViewBag.Title</h3>
        </div>
        <div class="card-body">
            <div class="bs-stepper linear">
                <div class="bs-stepper-content">
                    <form method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        @Html.ValidationSummary(true)
                        <input asp-for="Product.ProductId" hidden />
                        <div class="card-header p-2">
                            <ul class="nav nav-pills">
                                <li class="nav-item"><a class="nav-link active" href="#activity" data-toggle="tab">Thông tin chung</a></li>
                                <li class="nav-item"><a class="nav-link" href="#timeline" data-toggle="tab">Hình ảnh</a></li>
                                <li class="nav-item"><a class="nav-link" href="#settings" data-toggle="tab">SEO</a></li>
                            </ul>
                        </div><div class="card-body">
                            <div class="tab-content">
                                <div class="active tab-pane" id="activity">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label asp-for="Product.ProductName"></label>
                                                <input asp-for="Product.ProductName" class="form-control">
                                                <span asp-validation-for="Product.ProductName" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label asp-for="Product.CompanyName"></label>
                                                <input asp-for="Product.CompanyName" class="form-control">
                                                <span asp-validation-for="Product.CompanyName" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label asp-for="Product.ShortDescription"></label>
                                        <textarea asp-for="Product.ShortDescription" class="form-control"></textarea>
                                        <span asp-validation-for="Product.ShortDescription" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label asp-for="Product.LongDescription"></label>
                                        <textarea asp-for="Product.LongDescription" class="form-control"></textarea>
                                        <span asp-validation-for="Product.LongDescription" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label asp-for="Product.AdditionalDescription"></label>
                                        <textarea asp-for="Product.AdditionalDescription" class="form-control"></textarea>
                                        <span asp-validation-for="Product.AdditionalDescription" class="text-danger"></span>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label asp-for="Product.Price"></label>
                                                <input asp-for="Product.Price" class="form-control">
                                                <span asp-validation-for="Product.Price" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label asp-for="Product.Quantity"></label>
                                                <input asp-for="Product.Quantity" class="form-control">
                                                <span asp-validation-for="Product.Quantity" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label asp-for="Product.Size"></label>
                                                <input asp-for="Product.Size" class="form-control" placeholder="Ví dụ: S, M, L, XL hoặc 39, 40">
                                                <span asp-validation-for="Product.Size" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label asp-for="Product.Color"></label>
                                                <input asp-for="Product.Color" class="form-control" placeholder="Ví dụ: Đỏ, Xanh, Đen, Trắng">
                                                <span asp-validation-for="Product.Color" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4">
                                            <div class="form-group">
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" asp-for="Product.IsActive" class="custom-control-input" id="isActiveCheck">
                                                    <label class="custom-control-label" for="isActiveCheck">Hiển thị</label>
                                                    <span asp-validation-for="Product.IsActive" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        @*
                                        <div class="col-3">
                                            <div class="form-group">
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" asp-for="Product.IsCustomized" class="custom-control-input" id="isCustomizedCheck">
                                                    <label class="custom-control-label" for="isCustomizedCheck">Không Hiển Thị</label>
                                                    <span asp-validation-for="Product.IsCustomized" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        *@
                                        <div class="col-4">
                                            <div class="form-group">
                                                <label asp-for="Product.CategoryId"></label>
                                                <select id="PCategory" asp-for="Product.CategoryId" asp-items="@Model.CategoryList" class="form-control select2">
                                                    <option disabled selected>--- Chọn Danh mục ---</option>
                                                </select>
                                                <span asp-validation-for="Product.CategoryId" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="form-group">
                                                <label asp-for="Product.SubCategoryId"></label>
                                                <select id="PSubCategory" asp-for="Product.SubCategoryId" class="form-control select2">
                                                    <option disabled selected>--- Chọn Danh mục con ---</option>
                                                </select>
                                                <span asp-validation-for="Product.SubCategoryId" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <a asp-action="Index" class="btn btn-danger">Quay lại</a>
                                    <button type="submit" class="btn btn-primary">@(Model.Product.ProductId == 0 ? "Thêm mới" : "Cập nhật")</button>
                                </div>
                                <div class="tab-pane" id="timeline">
                                    <div class="row">
                                        <div class="col-md-12 text-right">
                                            <input type="file" id="imageChooser" name="files" class="btn btn-primary" multiple>
                                        </div>
                                        <div class="col-md-12">
                                            <table class="table table-hover" id="imagesPreview">
                                                <thead>
                                                    <tr>
                                                        <th>STT</th>
                                                        <th>Ảnh</th>
                                                        <th>Ảnh đại diện</th>
                                                        <th>Thao tác</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model.ProductImageList == null)
                                                    {
                                                        Model.ProductImageList = new List<ProductImage>();
                                                    }
                                                    @for (int i = 0; i < Model.ProductImageList.Count; i++)
                                                    {
                                                        <tr id="trow_@(i + 1)">
                                                            <input type="hidden" name="ProductImageList[@i].ImageId" value="@Model.ProductImageList[i].ImageId" />
                                                            <input type="hidden" name="ProductImageList[@i].ImageUrl" value="@Model.ProductImageList[i].ImageUrl" />

                                                            <td>@(i + 1)</td>
                                                            <td>
                                                                <img src="@Model.ProductImageList[i].ImageUrl" width="100">
                                                            </td>
                                                            <td>
                                                                <input name="isDefault"
                                                                       type="radio"
                                                                       value="@Model.ProductImageList[i].ImageId"
                                                                       checked="@(Model.ProductImageList[i].DefaultImage)" />
                                                            </td>
                                                            <td>
                                                                <button type="button" data-id="@Model.ProductImageList[i].ImageId" class="imageDeleteAction btn btn-sm btn-danger">
                                                                    Xóa
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="settings">
                                    <div class="card-body">
                                        <p>Nội dung SEO (ví dụ: Meta Title, Meta Description) sẽ được thêm vào khu vực này.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="card-footer">
        </div>
    </div>
</section>
@section scripts {
    <script>
        $(document).ready(function() {
            // Cập nhật Select/Dropdown để dùng class form-control và select2 (nếu có thư viện AdminLTE)
            $("#PCategory").on('change', function() {
                var url = "@Url.Content("~/Admin/Product/getSubCategoryById")";
                $.getJSON(url, { id: $("#PCategory").val() }, function(data) {
                    $('#PSubCategory').empty();
                    $('#PSubCategory').append("<option disabled selected>--- Chọn Danh mục con ---</option>");
                    var optionsArray = $.map(data, function(optionData, index) {
                        return '<option value=' + optionData.subCategoryId + '>' + optionData.subCategoryName + '</option>';
                    });
                    $('#PSubCategory').append(optionsArray.join(''));
                });
            });

            // ... (Phần xử lý ImageChooser và Delete giữ nguyên) ...

            $('#imageChooser').on('change', function () {
                const files = this.files;
                if (files.length > 0) {
                    $.each(files, function (index, file) {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                var rowCount = $('#imagesPreview tbody tr').length + 1;
                                // Đảm bảo input radio isDefault được đặt đúng tên
                                var radioInput = `<input name="isDefault" type="radio" value="${rowCount}" />`;

                                // Nếu đây là ảnh đầu tiên được thêm trong phiên này, tự động chọn làm mặc định
                                if (rowCount === 1 && $('#imagesPreview tbody tr input[name="isDefault"]:checked').length === 0) {
                                        radioInput = `<input name="isDefault" type="radio" value="${rowCount}" checked="checked" />`;
                                }

                                var row = `<tr id="trow_${rowCount}">
                                    <td>${rowCount}</td>
                                    <td>
                                        <img src="${e.target.result}" width="100">
                                    </td>
                                    <td>
                                        ${radioInput}
                                    </td>
                                    <td>
                                        <button type="button" data-id="${rowCount}" class="imageDeleteBtn btn btn-sm btn-danger">Xóa</button>
                                    </td>
                                </tr>`;
                                $('#imagesPreview tbody').append(row);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });

            $(document).on('click', '.imageDeleteBtn', function(){
                var conf = confirm("Bạn muốn xóa ảnh này không");
                if (conf === true) {
                    var _id = $(this).data('id');
                    var $rowToRemove = $('#trow_' + _id);
                    var wasChecked = $rowToRemove.find('input[name="isDefault"]').is(':checked'); // Kiểm tra nếu ảnh bị xóa là ảnh mặc định

                    $rowToRemove.fadeTo('fast', 0, function() {
                        $(this).remove();
                        $('#imagesPreview tbody tr').each(function (index) {
                            var newIndex = index + 1;
                            var $row = $(this);
                            $row.find('td:first').text(newIndex);
                            $row.attr('id', 'trow_' + newIndex);
                            $row.find('.imageDeleteBtn').data('id', newIndex);
                            $row.find('input[name="isDefault"]').val(newIndex);
                            // Cập nhật name cho input hidden của ảnh đã lưu (Nếu bạn đang sử dụng ProductImageList cho ảnh đã lưu)
                            $row.find('input[name^="ProductImageList"]').each(function() {
                                var oldName = $(this).attr('name');
                                var newName = oldName.replace(/\[\d+\]/, `[${index}]`);
                                $(this).attr('name', newName);
                            });
                        });

                        // Nếu ảnh mặc định bị xóa, đặt ảnh đầu tiên còn lại làm mặc định (nếu có ảnh)
                        if (wasChecked && $('#imagesPreview tbody tr').length > 0) {
                            $('#imagesPreview tbody tr:first').find('input[name="isDefault"]').prop('checked', true);
                        }
                    });
                }
            });

            $(document).on("click", ".imageDeleteAction", function () {
                var id = $(this).data("id");
                var conf = confirm("Bạn muốn xóa bản ghi này không");
                if (conf == true) {
                    var $rowToRemove = $('#trow_' + id);
                    var wasChecked = $rowToRemove.find('input[name="isDefault"]').is(':checked'); // Kiểm tra nếu ảnh bị xóa là ảnh mặc định

                    $.ajax({
                        url: "/Admin/Product/DeleteProductImage",
                        type: "POST",
                        data: { id: id },
                        success: function(rs) {
                            if (rs.success) {
                                $('#trow_' + id).fadeTo('fast', 0, function() {
                                    $(this).remove();
                                    $('#imagesPreview tbody tr').each(function (index) {
                                        var newIndex = index + 1;
                                        var $row = $(this);
                                        $row.find('td:first').text(newIndex);
                                        $row.attr('id', 'trow_' + newIndex);
                                        $row.find('.imageDeleteBtn').data('id', newIndex);
                                        $row.find('input[name="isDefault"]').val(newIndex);
                                        // Cập nhật name cho input hidden của ảnh đã lưu
                                        $row.find('input[name^="ProductImageList"]').each(function() {
                                            var oldName = $(this).attr('name');
                                            var newName = oldName.replace(/\[\d+\]/, `[${index}]`);
                                            $(this).attr('name', newName);
                                        });
                                    });

                                    // Nếu ảnh mặc định bị xóa, đặt ảnh đầu tiên còn lại làm mặc định (nếu có ảnh)
                                    if (wasChecked && $('#imagesPreview tbody tr').length > 0) {
                                        $('#imagesPreview tbody tr:first').find('input[name="isDefault"]').prop('checked', true);
                                    }
                                });
                            }
                            else {
                                alert("Xóa không thành công");
                            }
                        }
                    });
                }
            });
        });
    </script>
}